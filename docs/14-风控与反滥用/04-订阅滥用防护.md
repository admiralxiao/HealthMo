# 订阅滥用与反作弊（Trial / Refund / Restore）

更新时间：2026-01-30

---

## 1. 订阅状态以服务端为准（复述，防踩坑）
- 客户端不可信
- entitlement 来自 Apple 验证结果 + 服务端存储
- Server Notifications 能及时回收权益（强烈建议）

---

## 2. Trial 滥用（最常见）
### 2.1 防护策略（MVP）
- 同 device：
  - `trial_used = true`（一旦使用过，后续账号不再显示 trial）
- 同 user：
  - 只允许一次 trial（服务端记录）
- 降级策略：
  - 中风险：trial 入口不展示（但正常购买仍可用）
  - 高风险：购买入口隐藏 + 仅允许 restore（防刷）

参数建议：
- `trial.max_per_device = 1`
- `trial.max_per_user = 1`

---

## 3. Refund / Chargeback
- 收到退款通知后：
  - entitlement 立即回收
  - 客户端下一次刷新 entitlement 即降级
- 若客户端仍访问 premium API：
  - 返回 403 + 提示“Subscription inactive”
  - 计入风险分（R4）

---

## 4. Restore 滥用
信号：
- 高频 restore（短时多次）
处置：
- throttle restore endpoint
- high 风险触发二次验证

---

## 5. 付费相关接口的保护（建议 Level1）
- entitlement fetch
- purchase confirm
- restore confirm
→ 接入 App Attest / nonce/timestamp 防重放

---
