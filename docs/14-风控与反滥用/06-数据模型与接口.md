# 数据模型与接口（Back-end 实现规范）

更新时间：2026-01-30

---

## 1. 核心表（MVP）
### 1.1 risk_state
- user_id (pk)
- device_id
- risk_score int
- risk_level text (low/medium/high/critical)
- last_updated_at
- reasons jsonb

### 1.2 bans
- id (pk)
- user_id
- device_id (nullable)
- ban_reason
- ban_level (temporary/permanent)
- expires_at (nullable)
- created_at
- created_by

### 1.3 rate_limits（可选：用 Redis 更好）
- key (pk) 例如 `vision:user:{id}`
- window_sec
- count
- reset_at

### 1.4 usage_vision
- day date
- user_id
- device_id
- count
- cost_usd

---

## 2. 风控接口（MVP）
- `POST /risk/report`（客户端上报信号，可选）
- `GET /risk/state`（客户端查询当前风险等级 → 用于 UI 降级提示）
- `POST /admin/ban`（管理员封禁）
- `POST /admin/unban`（解封）

> 关键：风控不要暴露太多细节给客户端（避免被对手用来调参绕过）。

---

## 3. 决策点嵌入（必须）
在以下 API 进入点执行：
- vision endpoints
- entitlement endpoints
- login/register endpoints
- premium-only endpoints

伪代码：
```python
state = risk_service.get_state(user_id, device_id, ip_hash)
if state.level == "critical": deny()
elif state.level == "high": throttle_strict(); maybe_step_up()
elif state.level == "medium": throttle(); disable_trial()
else: allow()
```

---

## 4. 与远程配置联动（docs/12）
- 全局 kill switch（all/vision/payments）
- provider 切换（openai→none）
- quota/limit 阈值也可放入 params/flags 下发（快速调参）

---
