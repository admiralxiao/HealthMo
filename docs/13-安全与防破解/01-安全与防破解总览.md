# 安全与防破解总览（Threat Model & Strategy）— MVP v1+

更新时间：2026-01-30  
目标：上线后尽可能降低三类风险：  
1) **睡眠分期算法（C++）被逆向/拷贝**  
2) **会员系统被绕过（伪造 Premium）**  
3) **App 代码被抄袭/二开**  

> 说明：任何“防破解”都只能提升攻击成本，无法保证 100% 不被逆向。正确策略是：  
> **服务端权威 + 完整性验证 + 混淆加固 + 风险监控 + 快速止血（远程配置/封禁）**。

---

## 1. 威胁模型（你要防的是什么）
### 1.1 主要对手
- **普通破解用户**：使用“已修改 IPA / 插件”绕过付费
- **脚本/工具党**：自动化伪造响应、重放 token、刷 trial
- **竞争对手二开**：静态/动态分析，复刻 UI 与逻辑，复用算法库
- **专业逆向者**（少量）：hook StoreKit/Keychain，篡改函数返回，提取 C++ 核心算法

### 1.2 保护目标（优先级）
P0（必须）：
- Premium 权益：不能仅靠本地 bool 控制
- 计费正确：订阅状态必须服务端可验证、可回收
P1（强烈建议）：
- C++ 分期算法：提高逆向成本、减少可提取信息
P2（长期）：
- 抄袭与二开：技术 + 法务 + 运营组合拳

---

## 2. 总体架构原则（必须）
### 2.1 “服务端权威”的边界
- **Premium 权益**：服务端权威（强制）
- **算法输出**：可在端侧算（体验/隐私），但：
  - 输出结构要可追溯（params_version）
  - 关键价值（Explain/趋势/个性化）尽量依赖服务端数据闭环

### 2.2 “完整性验证”三件套（建议）
1) **App Attest / DeviceCheck**：证明请求来自你的未篡改 App（提高 API 防刷/防篡改）
2) **Receipt 验证**：订阅状态由 Apple 票据决定（而不是客户端）
3) **风控监控**：异常设备/账号自动降级/拉黑（配合远程配置）

---

## 3. 你现有文档体系的落点
- docs/12：远程配置与 kill switch（已具备止血能力）
- docs/07：埋点与指标（用于风控与异常检测）
- 本章（13）：把“加固与风控”补齐

---

## 4. MVP+ 建议的安全等级（按投入）
### Level 0（MVP 最小）
- 服务端 entitlement 权威 + StoreKit2 receipt 校验
- C++ 静态库符号剥离 + 基础混淆（编译级）
- Debug/越狱风险提示（不强拦）

### Level 1（上线后 2–4 周）
- App Attest 绑定关键 API（entitlement、scores、vision）
- 远程配置：可对高风险设备降级功能
- 订阅风控（试用滥用、异常 restore）

### Level 2（中长期）
- 更强的代码混淆/反调试/反篡改
- 算法“分层”：端侧只做基础，核心价值在云端闭环
- 法务/品牌/分发策略（防二开）

---
