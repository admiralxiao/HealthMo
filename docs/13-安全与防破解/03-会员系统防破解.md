# 会员系统防破解（Premium Entitlement）— iOS + 后端

更新时间：2026-01-30  
核心原则：**客户端永远不可信**。所有 Premium 权益的最终裁决必须来自“Apple 票据 + 你的服务端”。

---

## 1. 正确的权威链路（必须）
```mermaid
flowchart LR
  A[StoreKit2 purchase] --> B[Transaction/Receipt]
  B --> C[iOS send to backend\n(transaction or receipt)]
  C --> D[Backend verifies with Apple]
  D --> E[Entitlement stored server-side]
  E --> F[iOS fetch entitlement\n(+cache)]
  F --> G[FeatureGate enables premium]
```

---

## 2. 必做机制（MVP）
### 2.1 服务端验证（强制）
- iOS 购买后，必须把交易信息提交后端
- 后端向 Apple 验证订阅状态（有效/过期/退款/取消）
- entitlement 写入 DB，返回给客户端（JWT claims 或单独 endpoint）

### 2.2 App Store Server Notifications（强烈建议）
- Apple 会推送：续费、取消、退款、价格同意等状态变更
- 后端接收通知后更新 entitlement  
> 这样即使用户离线或绕过客户端逻辑，你也能回收权益。

### 2.3 客户端缓存（允许但要可回收）
- iOS 可缓存 `is_premium`（提升体验）
- 但必须：
  - 有 TTL（例如 24h）
  - 关键入口（Explain/Paywall）定期与后端对齐
  - 服务端可远程封禁（kill_switch/payments）

---

## 3. 防“假 Premium”绕过策略（建议）
### 3.1 API 级别的权益校验
- Premium 才能访问的 API（例如：Explain breakdown、云端个性化）：
  - 服务端必须校验 entitlement
  - 不要只在客户端隐藏 UI

### 3.2 App Attest 保护关键 API（Level 1）
- 对 entitlement/购买确认/分数上报等关键接口：
  - 要求携带 App Attest 生成的 assertion
  - 防止脚本伪造请求、批量刷接口

### 3.3 Trial 滥用风控
- 规则信号（只做风险评分）：
  - 同设备大量创建账号
  - 大量 restore/purchase 失败
  - 频繁切换区域/时区
- 处置：限制 trial、要求邮箱验证、限制购买入口（远程配置）

---

## 4. 常见漏洞避免（必须）
- ❌ 仅靠本地 bool 解锁 Premium
- ❌ 仅用 Keychain 标记“已买”
- ❌ 仅校验“曾经买过”而不看过期/退款
- ✅ 永远以 Apple 验证结果为准
- ✅ 订阅状态变更要能“收回”

---

## 5. 可落地清单（MVP 必做）
- [ ] 后端 entitlement 表（user_id, product_id, expires_at, status）
- [ ] iOS purchase 后上报后端（transaction）
- [ ] iOS 定期拉取 entitlement（启动/24h）
- [ ] Premium API 服务端校验
- [ ] 订阅状态变化埋点（subscribe_* / restore_*）

---
