# 工程目录与模块拆分（iOS / Backend）— 商业化代码骨架

更新时间：2026-01-30  
目标：给 Claude CLI “直接生成代码”的骨架与文件结构，避免在实现阶段反复改架构。

---

## 1) iOS（Swift, iOS 15.6+）目录建议
> 以 MVVM + Coordinator 组织，商业化模块独立，方便复用与测试。

```
App/
  AppDelegate.swift
  SceneDelegate.swift
  RootCoordinator.swift

Core/
  Networking/
    APIClient.swift
    Endpoints.swift
    APIError.swift
    RequestSigning.swift (optional AppAttest nonce)
  Storage/
    KeychainStore.swift
    SecureStore.swift
    CacheStore.swift
  RemoteConfig/
    RemoteConfigStore.swift
    RemoteConfigModels.swift
  Analytics/
    Analytics.swift
    Event.swift
    EventPayloads.swift
  Risk/
    RiskStore.swift
    RiskModels.swift
  Entitlement/
    EntitlementStore.swift
    EntitlementModels.swift

Features/
  Monetization/
    PaywallCoordinator.swift
    PaywallFlowState.swift
    OfferDecisionEngine.swift
    MonetizationModels.swift
    Views/
      WelcomeView.swift
      QuestionnaireView.swift
      ValuePreviewView.swift
      TechProofView.swift
      PaywallView.swift
      PurchaseProcessingSheet.swift
      PurchaseSuccessView.swift
    ViewModels/
      WelcomeViewModel.swift
      QuestionnaireViewModel.swift
      PaywallViewModel.swift
    StoreKit/
      PurchaseManager.swift
      StoreKitProducts.swift
      StoreKitErrors.swift
  Today/
    TodayView.swift
    TodayViewModel.swift
  Settings/
    SettingsView.swift
    RestorePurchasesView.swift
```

---

## 2) Backend（FastAPI）目录建议
```
backend/
  app/
    main.py
    api/
      routes_config.py
      routes_entitlement.py
      routes_iap.py
      routes_risk.py
      routes_events.py
    core/
      settings.py
      security.py (optional)
    services/
      config_service.py
      iap_service.py
      entitlement_service.py
      risk_service.py
      analytics_service.py
    db/
      session.py
      models.py
      migrations/
    schemas/
      config.py
      entitlement.py
      iap.py
      risk.py
      events.py
```

---

## 3) 模块边界（必须）
- Monetization（UI/flow/offer）**不直接决定 premium**：仅展示与引导
- EntitlementStore **唯一权威**（客户端）：任何 feature gate 依赖它
- PurchaseManager 只负责 StoreKit2，结果必须交给后端验证
- RemoteConfigStore 提供 flags/params/providers 给 OfferDecisionEngine 与 UI

---

## 4) 单元测试最小集合（建议）
- OfferDecisionEngine：A/B/C 触发规则、risk 禁折扣
- EntitlementStore：TTL/强刷新点
- PurchaseManager：purchase/restore 错误映射
- PaywallViewModel：埋点是否带 offer_id/plan_id

---
